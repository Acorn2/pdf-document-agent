# 数据库本地安装指南

本文档介绍如何在Mac系统上安装PostgreSQL和ChromaDB。

## PostgreSQL安装

### 方法一：使用Homebrew安装（推荐）

```bash
# 1. 安装PostgreSQL
brew install postgresql@15

brew uninstall postgresql@15

# 2. 启动PostgreSQL服务
brew services start postgresql@15

# 3. 创建数据库用户（可选）
createuser --interactive --pwprompt

# 4. 创建数据库
createdb your_database_name
```

### 方法二：使用官方安装包

1. 访问 [PostgreSQL官网](https://www.postgresql.org/download/macosx/)
2. 下载Mac版本的安装包
3. 按照安装向导完成安装

### PostgreSQL基本配置

```bash
# 连接到PostgreSQL
psql postgres

# 在psql中执行以下SQL命令：
CREATE USER your_username WITH PASSWORD 'your_password';
CREATE DATABASE your_database OWNER your_username;
GRANT ALL PRIVILEGES ON DATABASE your_database TO your_username;
```

### 验证PostgreSQL安装

```bash
# 检查PostgreSQL版本
psql --version


# 查看Postgres.app版本
ls /Applications/Postgres.app/Contents/Versions/15/bin/

# 配置环境变量

vi ~/.bash_profile

export PATH="/Applications/Postgres.app/Contents/Versions/15/bin:$PATH"

source ~/.bash_profile

# 验证安装
psql --version

# 连接测试
psql -h localhost -U postgres
```

## ChromaDB安装

### 方法一：使用虚拟环境安装（推荐）

```bash
# 1. 创建虚拟环境
python3 -m venv chromadb_env

# 2. 激活虚拟环境
source chromadb_env/bin/activate

# 3. 安装ChromaDB
pip install chromadb

# 4. 验证安装
python -c "import chromadb; print('ChromaDB安装成功！')"

# 注意：每次使用前需要激活虚拟环境
source chromadb_env/bin/activate
```

### 方法二：使用pipx安装

```bash
# 安装pipx（如果未安装）
brew install pipx

# 使用pipx安装ChromaDB
pipx install chromadb
```

### 方法三：使用Docker运行（最简单）

```bash
# 拉取ChromaDB镜像
docker pull chromadb/chroma

# 运行ChromaDB容器
docker run -p 8000:8000 chromadb/chroma
```

### 常见问题：externally-managed-environment错误

这是macOS新版本的安全特性，解决方法：
1. 使用虚拟环境（推荐）
2. 使用pipx安装
3. 使用Docker容器
4. 不推荐：使用 `--break-system-packages` 标志

### ChromaDB基本使用示例

```python
import chromadb

# 创建客户端
client = chromadb.Client()

# 创建集合
collection = client.create_collection(name="my_collection")

# 添加文档
collection.add(
    documents=["This is a document", "This is another document"],
    metadatas=[{"source": "my_source"}, {"source": "my_source"}],
    ids=["id1", "id2"]
)

# 查询
results = collection.query(
    query_texts=["This is a query document"],
    n_results=2
)
```

### 验证ChromaDB安装

创建测试文件 `test_chroma.py`：

```python
import chromadb
print("ChromaDB安装成功！")
print(f"ChromaDB版本: {chromadb.__version__}")
```

运行测试：

```bash
python3 test_chroma.py
```

## 环境变量配置

在 `~/.zshrc` 或 `~/.bash_profile` 中添加：

```bash
# PostgreSQL环境变量
export PATH="/opt/homebrew/opt/postgresql@15/bin:$PATH"
export PGDATA="/opt/homebrew/var/postgres"

# 重新加载配置
source ~/.zshrc
```

## 常见问题解决

### PostgreSQL相关问题

```bash
# 权限问题解决
sudo chown -R $(whoami) /usr/local/var/postgres

# 重新初始化数据库
initdb /usr/local/var/postgres

# 重启服务
brew services restart postgresql@15
```

### ChromaDB相关问题

```bash
# 升级pip解决安装问题
pip3 install --upgrade pip

# 使用虚拟环境
python3 -m venv venv
source venv/bin/activate
pip install chromadb
```

## 数据库连接配置

### PostgreSQL连接字符串示例

```python
# Python连接示例
import psycopg2

connection = psycopg2.connect(
    host="localhost",
    database="your_database",
    user="your_username",
    password="your_password",
    port="5432"
)
```

### ChromaDB连接示例

```python
# 本地连接
import chromadb
client = chromadb.Client()

# 远程连接
client = chromadb.HttpClient(host="localhost", port=8000)
```

## 性能优化建议

### PostgreSQL优化

1. 调整 `postgresql.conf` 中的内存设置
2. 优化查询索引
3. 定期执行 `VACUUM` 和 `ANALYZE`

### ChromaDB优化

1. 合理设置集合大小
2. 选择合适的嵌入模型
3. 优化查询参数

---

*最后更新时间：2024年*
